<!DOCTYPE html>
<html>
<head>
  <title>Register & Approve (WalletManager)</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 30px auto; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px 0; cursor: pointer; }
    pre { background: #f0f0f0; padding: 15px; height: 200px; overflow-y: auto; border-radius: 5px; }
  </style>
</head>
<body>

  <h2>Wallet Connect + Register (WalletManager) + Approve</h2>

  <button id="connectBtn">Connect Wallet</button><br>
  <button id="registerApproveBtn" disabled>Register & Approve</button>

  <pre id="log"></pre>

<script>
  const WALLET_MANAGER = "0xE7868Fda3A7f3eA4C41f065Fc3bfB07030D0dc78";  // WalletManager address
  const TOKEN = "0xDc6cc6d847DF088C3eEDA72404864B59c0cD53B2";           // Token address

  const ERC20_ABI = [
    "function allowance(address owner, address spender) view returns (uint256)",
    "function approve(address spender, uint256 amount) returns (bool)"
  ];

  const WALLET_MANAGER_ABI = [
    "function register() external"
  ];

  let provider, signer, userAddress;
  let tokenContract, walletManagerContract;

  const logEl = document.getElementById("log");
  const connectBtn = document.getElementById("connectBtn");
  const registerApproveBtn = document.getElementById("registerApproveBtn");

  function log(msg) {
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
    console.log(msg);
  }
  function clearLog() {
    logEl.textContent = "";
  }

  connectBtn.onclick = async () => {
    if (!window.ethereum) {
      alert("MetaMask nahi mila! Please install MetaMask.");
      return;
    }

    try {
      await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();

      tokenContract = new ethers.Contract(TOKEN, ERC20_ABI, signer);
      walletManagerContract = new ethers.Contract(WALLET_MANAGER, WALLET_MANAGER_ABI, signer);

      log(`✅ Wallet connected: ${userAddress}`);
      registerApproveBtn.disabled = false;
    } catch (err) {
      alert("Wallet connect karte waqt error aaya: " + err.message);
    }
  };

  registerApproveBtn.onclick = async () => {
    if (!signer) {
      alert("Pehle wallet connect karo!");
      return;
    }

    clearLog();

    try {
      // 1. WalletManager me register karna
      log("WalletManager me register kar rahe hain...");
      let txRegister = await walletManagerContract.register();
      log(`Register transaction bheja: ${txRegister.hash}`);
      await txRegister.wait();
      log("✅ Register transaction confirm ho gaya!");

      // 2. WalletManager ke liye token approval
      log("WalletManager ke liye allowance check kar rahe hain...");
      let allowance = await tokenContract.allowance(userAddress, WALLET_MANAGER);
      log(`Current allowance: ${allowance.toString()}`);

      const maxUint = ethers.constants.MaxUint256;

      if (allowance.lt(ethers.BigNumber.from("1"))) {
        log("Allowance kam hai, approve transaction bhej rahe hain...");
        let txApprove = await tokenContract.approve(WALLET_MANAGER, maxUint);
        log(`Approve transaction bheja: ${txApprove.hash}`);
        await txApprove.wait();
        log("✅ Approve transaction confirm ho gaya!");
      } else {
        log("Allowance pehle se hi sufficient hai.");
      }

      alert("Registration aur Approval dono successful ho gaye!");
    } catch (error) {
      log("❌ Error aaya: " + (error.message || error));
      alert("Kuch gadbad hui, console mein dekhein.");
    }
  };
</script>

</body>
</html>

