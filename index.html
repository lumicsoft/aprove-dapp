<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AiEarn Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* Custom CSS for vibrant look and feel */
        
        /* Telegram Theme Variables */
        :root {
            --tg-bg-color: #f0f2f5; /* Default fallback */
            --tg-text-color: #1f2937; /* Default fallback */
            --tg-hint-color: #9ca3af;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-bg-color); 
            color: var(--tg-text-color); 
        }
        
        /* Tailwind classes based on TG theme */
        .text-gray-600 { color: var(--tg-hint-color); }
        .bg-white { background-color: var(--tg-bg-color); }
        
        /* Premium TP Card Style (Updated: Compact) */
        .tp-premium-card {
            position: relative;
            background: white;
            overflow: hidden;
            border: none; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .tp-premium-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Vibrant border effect */
            border: 4px solid transparent; 
            border-radius: 1.5rem; /* Matches rounded-3xl */
            background: linear-gradient(135deg, #FF6B8A, #3B82F6) border-box; 
            -webkit-mask: 
                linear-gradient(#fff 0 0) padding-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        
        /* Gradient Button Styles (Unchanged) */
        .green-gradient-button {
            background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
        }
        .green-gradient-button:hover {
            opacity: 0.95;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.6);
        }
        .pink-gradient-button {
            background: linear-gradient(135deg, #FF3D69 0%, #FF6B8A 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(255, 61, 105, 0.4);
        }
        .pink-gradient-button:hover {
            opacity: 0.95;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 61, 105, 0.6);
        }
        .orange-gradient-button {
            background: linear-gradient(135deg, #F97316 0%, #FBBF24 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4);
        }
        .orange-gradient-button:hover {
            opacity: 0.95;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(249, 115, 22, 0.6);
        }
        .blue-gradient-button {
            background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }
        .blue-gradient-button:hover {
            opacity: 0.95;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.6);
        }
        .roi-table-header {
            background-color: #e5e7eb;
        }
        .hot-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #EF4444;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.25rem 1.5rem;
            transform: rotate(45deg) translate(25%, -25%);
            transform-origin: 100% 0;
            width: 120px;
            text-align: center;
        }
        .input-usdt::-webkit-outer-spin-button,
        .input-usdt::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-usdt {
            -moz-appearance: textfield; /* Firefox */
        }
        .view {
            animation: fadeIn 0.3s ease-in-out;
        }
        .hidden-view {
            display: none;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pagination-button {
            padding: 0.5rem 0.75rem;
            margin: 0 0.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .pagination-button.active {
            background-color: #3B82F6;
            color: white;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.5);
        }
        .pagination-button:not(.active):hover {
            background-color: #E5E7EB;
        }
        /* AI Trading Status Table Premium Styling */
        .trading-status-th {
            background-color: #1f2937;
            color: white;
        }
        .premium-trading-table td {
            padding-top: 0.6rem; 
            padding-bottom: 0.6rem;
            line-height: 1.2;
        }
        .pnl-cell {
            font-size: 1.1rem; /* Slightly larger for profit */
        }
        
    </style>
</head>
<body class="min-h-screen">

    <header id="header" class="bg-white p-4 shadow-md sticky top-0 z-20"></header>

    <div id="appContainer" class="max-w-lg mx-auto p-4 space-y-5 pb-24">
        
        <section id="dashboardView" data-view="dashboard" class="view space-y-5">
            
            <div class="flex justify-between items-center text-sm font-medium">
                <span class="text-gray-600 font-semibold">You Earned:</span>
                <div class="flex items-center space-x-3">
                    <span class="bg-white rounded-full px-4 py-1.5 text-green-600 border border-green-300 shadow-md flex items-center">
                        <i data-lucide="gem" class="w-4 h-4 mr-1.5 text-green-500"></i> <span class="font-bold text-base">0.0295</span>
                    </span>
                    <button onclick="navigateTo('withdrawalView')" class="flex items-center bg-orange-500 text-white rounded-full px-4 py-1.5 text-sm font-bold hover:bg-orange-600 transition shadow-md">
                        Withdraw <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                    </button>
                    <button onclick="console.log('Support')" class="text-blue-500 hover:text-blue-700 p-1 rounded-full">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <div class="bg-gray-800 rounded-xl p-3 flex justify-between items-center shadow-2xl border-l-4 border-green-500">
                <div class="flex items-center">
                    <i data-lucide="zap" class="w-6 h-6 text-yellow-400 mr-2"></i>
                    <span class="text-white text-base font-semibold">WEEKEND EARN FAST</span>
                </div>
                <div class="flex items-center">
                    <span class="text-green-400 text-xl font-extrabold mr-2">Earn â¬†30%</span>
                    <span class="text-white text-sm">in 48h</span>
                </div>
                <button id="weekendDashboardButton" onclick="navigateTo('weekendEarnView')" class="bg-yellow-400 text-gray-900 text-xs font-extrabold px-3 py-1.5 rounded-full hover:bg-yellow-500 transition">
                    LET'S GO
                </button>
            </div>

            <div class="p-4 rounded-3xl shadow-2xl text-center tp-premium-card"> <div class="flex justify-between items-center mb-3"> <div class="flex items-center">
                        <span class="text-gray-600 font-semibold text-base">TP (Trade Power)</span> <i data-lucide="info" class="w-4 h-4 text-gray-400 ml-1 cursor-pointer"></i>
                    </div>
                    <i data-lucide="refresh-ccw" class="w-5 h-5 text-blue-500 cursor-pointer hover:rotate-180 transition duration-500"></i>
                </div>

                <div class="flex items-center justify-center mb-4 py-2"> <span class="text-7xl font-black text-gray-900 tracking-tighter">0.5</span>
                </div>

                <p class="text-sm mb-3 text-gray-700 flex items-center justify-center"> <span class="text-gray-500 mr-2">Daily Earn:</span>
                    <i data-lucide="dollar-sign" class="w-4 h-4 text-green-600"></i>
                    <span class="font-bold text-green-600 ml-0.5">$0.028</span>
                    <button onclick="navigateTo('dailyEarningHistoryView')" class="text-xs text-gray-500 ml-3 hover:text-gray-700 flex items-center bg-gray-100 rounded-full px-2 py-1 shadow-inner">
                        <i data-lucide="history" class="w-4 h-4 text-gray-400 mr-1"></i> History
                    </button>
                </p>

                <div class="flex justify-center mb-6"> <div id="settlement-timer" class="bg-purple-50 text-purple-700 font-bold rounded-full px-5 py-2 text-md shadow-inner border border-purple-200">
                        Settlement time: 00h 00m 00s
                    </div>
                </div>

                <div class="flex space-x-3 justify-center">
                    <button onclick="navigateTo('buyTPView')" class="green-gradient-button flex-1 py-3 px-4 rounded-xl text-white font-extrabold text-sm flex items-center justify-center">
                        <i data-lucide="trending-up" class="w-4 h-4 mr-1"></i> Buy TP
                    </button>
                    <button onclick="navigateTo('referEarnView')" class="pink-gradient-button flex-1 py-3 px-4 rounded-xl text-white font-extrabold text-sm flex items-center justify-center">
                        <span class="text-yellow-300 text-lg font-black mr-1">$10</span> Refer & Earn
                    </button>
                </div>
            </div>
            <div class="bg-white p-6 pt-10 rounded-3xl shadow-2xl mt-6 relative overflow-hidden border border-gray-100">
                <div class="hot-badge shadow-lg">HOT</div>
                <h2 class="text-xl font-bold mb-4 text-gray-800">Return on Investment in AiEarn</h2>
                
                <table class="w-full text-left border-collapse rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 roi-table-header text-sm font-bold text-gray-700">TP Purchased (USDT)</th>
                            <th class="py-3 px-4 roi-table-header text-sm font-bold text-gray-700 text-right">Daily Return Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-gray-600 font-medium">â‰¥ $0</td>
                            <td class="py-3 px-4 text-right font-semibold text-green-500" data-rate="0.055">5.5%</td>
                        </tr>
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-gray-600 font-medium">â‰¥ $20</td>
                            <td class="py-3 px-4 text-right font-semibold text-green-500" data-rate="0.060">6%</td>
                        </tr>
                        <tr class="border-b border-gray-200 bg-red-50/70">
                            <td class="py-4 px-4 text-gray-700 font-bold">
                                â‰¥ $300 <span class="text-red-500 text-lg ml-1">ðŸ”¥ðŸ”¥ðŸ”¥</span>
                            </td>
                            <td class="py-4 px-4 text-right font-extrabold text-green-700 text-lg" data-rate="0.065">6.5%</td>
                        </tr>
                        <tr class="bg-red-100/70">
                            <td class="py-4 px-4 text-gray-700 font-bold">
                                â‰¥ $3000-10000 <span class="text-red-600 text-lg ml-1">ðŸ”¥</span>
                            </td>
                            <td class="py-4 px-4 text-right font-extrabold text-green-700 text-lg" data-rate="0.070">7%</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="flex space-x-4 pt-4">
                 <button onclick="navigateTo('aiTradingStatusView')" class="blue-gradient-button flex-1 py-3 px-4 rounded-xl text-white font-bold text-sm flex items-center justify-center shadow-lg">
                    <i data-lucide="activity" class="w-4 h-4 mr-2"></i> AI Trading Status
                </button>
                <button onclick="navigateTo('myTradePowerView')" class="orange-gradient-button flex-1 py-3 px-4 rounded-xl text-white font-bold text-sm flex items-center justify-center shadow-lg">
                    <i data-lucide="layers-3d" class="w-4 h-4 mr-2"></i> My Trade Power
                </button>
            </div>
            
        </section>

        <section id="weekendEarnView" data-view="weekend-earn" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-6 border-b pb-3">
                <i data-lucide="zap" class="w-6 h-6 mr-2 text-yellow-500"></i> WEEKEND EARN FAST
            </h2>
            
            <p class="text-lg font-bold text-gray-700 mb-4 bg-yellow-100 p-3 rounded-lg border-l-4 border-yellow-500">
                âš¡ Earn 30% in 48 Hours! (Fixed Rate)
            </p>

            <button onclick="navigateTo('weekendEarnHistoryView')" class="w-full text-sm font-semibold text-blue-600 hover:text-blue-800 mb-6 flex items-center justify-center py-2 bg-blue-50 rounded-lg shadow-inner">
                <i data-lucide="history" class="w-4 h-4 mr-2"></i> View Weekend Earn History
            </button>


            <p id="weekendRestrictionText" class="text-gray-600 mb-6">Invest for a short-term, high-return opportunity. (Minimum 100 USDT, **Once per week**)</p>

            <div class="mb-8">
                <label for="weekendAmount" class="block text-sm font-semibold text-gray-700 mb-2">Investment Amount (USDT)</label>
                <div class="relative rounded-xl shadow-inner border border-gray-200">
                    <input type="number" id="weekendAmount" placeholder="Min. 100 USDT" 
                           min="100" step="0.01" value=""
                           oninput="calculateWeekendReturn(this.value)"
                           class="input-usdt w-full p-4 pr-16 text-2xl font-bold text-gray-900 border-none bg-transparent focus:ring-yellow-500 focus:border-yellow-500 rounded-xl"
                           required>
                    <span class="absolute right-0 top-0 bottom-0 flex items-center pr-4 text-xl font-extrabold text-yellow-600">USDT</span>
                </div>
            </div>

            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-xl mb-8 shadow-inner">
                <p class="text-sm font-medium text-yellow-700 flex items-center mb-1">
                    <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i> Total Return Rate:
                    <span id="weekendRateDisplay" class="font-extrabold text-yellow-800 ml-1">30%</span>
                </p>
                <p class="text-lg font-bold text-yellow-900 flex items-center">
                    <i data-lucide="gem" class="w-5 h-5 mr-2"></i> Est. 48h Earnings: 
                    <span id="weekendReturnAmount" class="ml-1 text-2xl">0.00 USDT</span>
                </p>
            </div>

            <button onclick="simulateWeekendGateway()" id="weekendBuyButton" disabled
                    class="w-full orange-gradient-button py-4 rounded-xl text-white font-extrabold text-lg shadow-lg opacity-50 cursor-not-allowed">
                <i data-lucide="lock" class="w-5 h-5 mr-2 inline-block"></i> Invest Now (max 30 USDT)
            </button>
        </section>

        <section id="weekendEarnHistoryView" data-view="weekend-earn-history" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-6 border-b pb-3">
                <i data-lucide="history" class="w-6 h-6 mr-2 text-yellow-500"></i> Weekend Earn History
            </h2>
            <div class="overflow-x-auto rounded-xl shadow-md border border-gray-200">
                <table class="min-w-full text-left border-collapse">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700">Date/Time</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-right">Invested</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-right">Return</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="weekendEarnHistoryBody">
                        </tbody>
                </table>
            </div>
            <div id="weekendEarnHistoryPagination" class="flex justify-center items-center mt-6"></div>
        </section>
        
        <section id="buyTPView" data-view="buy-tp" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
            <i data-lucide="wallet" class="w-6 h-6 mr-2 text-green-500"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Buy Trade Power (TP)</h2>
            
            <button onclick="navigateTo('buyTPHistoryView')" class="w-full text-sm font-semibold text-blue-600 hover:text-blue-800 mb-6 flex items-center justify-center py-2 bg-blue-50 rounded-lg shadow-inner">
                <i data-lucide="layers" class="w-4 h-4 mr-2"></i> View TP Purchase History
            </button>


            <p class="text-gray-600 mb-6">Deposit USDT to increase your Trade Power and maximize your Daily ROI.</p>

            <div class="mb-8">
                <label for="usdtAmount" class="block text-sm font-semibold text-gray-700 mb-2">Investment Amount (USDT)</label>
                <div class="relative rounded-xl shadow-inner border border-gray-200">
                    <input type="number" id="usdtAmount" placeholder="Min. 10 USDT" 
                           min="10" step="0.01" value=""
                           oninput="calculateReturn(this.value)"
                           class="input-usdt w-full p-4 pr-16 text-2xl font-bold text-gray-900 border-none bg-transparent focus:ring-green-500 focus:border-green-500 rounded-xl"
                           required>
                    <span class="absolute right-0 top-0 bottom-0 flex items-center pr-4 text-xl font-extrabold text-green-600">USDT</span>
                </div>
            </div>

            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-xl mb-8 shadow-inner">
                <p class="text-sm font-medium text-green-700 flex items-center mb-1">
                    <i data-lucide="zap" class="w-4 h-4 mr-2"></i> Your Daily Return Rate:
                    <span id="dailyRateDisplay" class="font-extrabold text-green-800 ml-1">0%</span>
                </p>
                <p class="text-lg font-bold text-green-900 flex items-center">
                    <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i> Est. Daily Earnings: 
                    <span id="dailyReturnAmount" class="ml-1 text-2xl">0.00 USDT</span>
                </p>
            </div>

            <button onclick="simulateGateway()" id="buyNowButton" disabled
                    class="w-full green-gradient-button py-4 rounded-xl text-white font-extrabold text-lg shadow-lg opacity-50 cursor-not-allowed">
                <i data-lucide="lock" class="w-5 h-5 mr-2 inline-block"></i> Buy Now (Min 10 USDT)
            </button>
        </section>
        
        <section id="buyTPHistoryView" data-view="buy-tp-history" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-6 border-b pb-3">
                <i data-lucide="layers" class="w-6 h-6 mr-2 text-green-500"></i> TP Purchase History
            </h2>
            <div class="overflow-x-auto rounded-xl shadow-md border border-gray-200">
                <table class="min-w-full text-left border-collapse">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700">Date/Time</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-right">Amount</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-right">Daily $$ Earning</th>
                        </tr>
                    </thead>
                    <tbody id="buyTPHistoryBody">
                        </tbody>
                </table>
            </div>
            <div id="buyTPHistoryPagination" class="flex justify-center items-center mt-6"></div>
        </section>
        
        <section id="referEarnView" data-view="refer-earn" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
             <i data-lucide="users" class="w-6 h-6 mr-2 text-pink-500"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Elite Referral Program</h2>
            
            <div class="bg-pink-50 border-l-4 border-pink-500 p-4 rounded-xl mb-6 shadow-inner">
                <p class="text-sm font-semibold text-pink-700 mb-1">Total Referral Earnings:</p>
                <span class="text-4xl font-extrabold text-pink-600">$1,335.00</span>
                <p class="text-xs text-gray-500 mt-2">Earn up to 10 Levels deep.</p>
            </div>
            
            <div class="mb-8">
                <label for="referralLink" class="block text-sm font-semibold text-gray-700 mb-2">Your Invitation Link</label>
                <div class="flex">
                    <input type="text" id="referralLink" value="https://t.me/AproveDappBot?start=mock-user-12345" readonly
                           class="flex-1 p-3 border border-gray-300 rounded-l-xl text-gray-600 bg-gray-50 text-sm truncate">
                    <button onclick="copyReferralLink()" class="pink-gradient-button text-white px-4 rounded-r-xl font-bold text-sm flex items-center">
                        <i data-lucide="copy" class="w-4 h-4 mr-2"></i> Copy
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Share this link to invite users via Telegram Bot.</p>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                 <i data-lucide="award" class="w-5 h-5 mr-2 text-yellow-500"></i> Level Structure
            </h3>
            <div class="overflow-x-auto rounded-xl shadow-md border border-gray-200">
                <table class="min-w-full text-left border-collapse">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700">Level</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-center">Users</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-right">Deposited</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-right">Earned</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-center">Details</th>
                        </tr>
                    </thead>
                    <tbody id="referralTableBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="levelUsersView" data-view="level-users" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
            <h2 id="levelUsersTitle" class="text-2xl font-bold text-gray-800 flex items-center mb-6 border-b pb-3">
                <i data-lucide="users" class="w-6 h-6 mr-2 text-blue-500"></i> Users in Level X
            </h2>
            <p class="text-gray-600 mb-6 text-sm">Details of users and their initial investment (deposit) in this level.</p>
            
            <div id="levelUsersList" class="space-y-4">
                </div>
        </section>

        <section id="aiTradingStatusView" data-view="ai-trading-status" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
             <i data-lucide="activity" class="w-6 h-6 mr-2 text-blue-500"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">AI Trading Status</h2>
            
            <p class="text-gray-600 mb-4 text-sm font-semibold">Live trades executed by the AI on Forex pairs. (Last 10 Profitable Entries)</p>
            
            <div class="overflow-x-auto rounded-xl shadow-md border border-gray-200">
                <table class="min-w-full text-left border-collapse premium-trading-table">
                    <thead class="bg-gray-800 sticky top-0">
                        <tr>
                            <th class="py-3 px-3 text-xs font-bold text-white uppercase trading-status-th" style="width: 38%;">Pair (Side | X)</th>
                            <th class="py-3 px-1 text-xs font-bold text-white uppercase trading-status-th text-center" style="width: 32%;">Entry / Current</th>
                            <th class="py-3 px-3 text-xs font-bold text-white uppercase trading-status-th text-right" style="width: 18%;">% Profit</th>
                            <th class="py-3 px-1 text-xs font-bold text-white uppercase trading-status-th text-right" style="width: 12%;">Time</th>
                        </tr>
                    </thead>
                    <tbody id="aiTradingHistoryBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="myTradePowerView" data-view="my-trade-power" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
             <i data-lucide="layers-3d" class="w-6 h-6 mr-2 text-orange-500"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">My Trade Power</h2>
            <p class="text-gray-600 mb-6 text-sm">All your active TP packages with a 20-day validity status.</p>

            <div id="myTPPackagesList" class="space-y-6">
                </div>
        </section>
        
        <section id="introductionView" data-view="introduction" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-6 border-b pb-3">
                <i data-lucide="info" class="w-6 h-6 mr-2 text-blue-500"></i> AiEarn: Company Profile
            </h2>
            
            <div class="space-y-6">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-xl shadow-inner">
                    <h3 class="text-xl font-bold text-blue-800 mb-2 flex items-center">
                         <i data-lucide="brain" class="w-5 h-5 mr-2"></i> Our Vision
                    </h3>
                    <p class="text-gray-700">AiEarn is dedicated to pioneering AI-driven quantitative trading on major financial markets. We leverage advanced machine learning models (Quantum AI Engine) to identify high-probability trade setups, ensuring consistent and stable returns for our global investor community. Our mission is to democratize high-frequency trading through transparent and accessible technology.</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-xl shadow-md border border-gray-100">
                        <i data-lucide="shield-check" class="w-6 h-6 text-green-600 mb-2"></i>
                        <p class="font-bold text-gray-800 text-sm">Security & Compliance</p>
                        <p class="text-xs text-gray-600">Regulated operation with segregated funds protection.</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-xl shadow-md border border-gray-100">
                        <i data-lucide="trending-up" class="w-6 h-6 text-purple-600 mb-2"></i>
                        <p class="font-bold text-gray-800 text-sm">High-Frequency Execution</p>
                        <p class="text-xs text-gray-600">Millions of trades executed daily with ultra-low latency.</p>
                    </div>
                </div>

                <h3 class="text-xl font-bold text-gray-800 pt-4 border-t mt-6 flex items-center">
                    <i data-lucide="file-text" class="w-5 h-5 mr-2 text-red-500"></i> Regulatory Documents
                </h3>
                <p class="text-gray-600 text-sm mb-4">View our official registration and compliance certificates.</p>

                <div class="space-y-3">
                    <a href="javascript:void(0)" onclick="showMessage('Document View', 'Viewing: Financial Regulator License (Mock Document)')" class="flex items-center p-4 bg-red-50 border border-red-200 rounded-xl shadow hover:shadow-lg transition">
                        <i data-lucide="file-badge" class="w-8 h-8 mr-4 text-red-600"></i>
                        <div>
                            <p class="font-bold text-red-800">Global Financial Regulator License</p>
                            <p class="text-sm text-gray-600">License ID: GF-2025-A12X | Valid till: 2030</p>
                        </div>
                        <i data-lucide="eye" class="w-5 h-5 ml-auto text-red-500"></i>
                    </a>
                    <a href="javascript:void(0)" onclick="showMessage('Document View', 'Viewing: Certificate of Incorporation (Mock Document)')" class="flex items-center p-4 bg-green-50 border border-green-200 rounded-xl shadow hover:shadow-lg transition">
                        <i data-lucide="file-check" class="w-8 h-8 mr-4 text-green-600"></i>
                        <div>
                            <p class="font-bold text-green-800">Certificate of Incorporation</p>
                            <p class="text-sm text-gray-600">Registration No: AI-INC-98765 | Date: 2022-05-15</p>
                        </div>
                        <i data-lucide="eye" class="w-5 h-5 ml-auto text-green-500"></i>
                    </a>
                </div>
            </div>
        </section>

        <section id="withdrawalView" data-view="withdrawal" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
             <i data-lucide="arrow-down-left" class="w-6 h-6 mr-2 text-orange-500"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Request Withdrawal</h2>
            
            <div class="mb-6 bg-orange-50 border-l-4 border-orange-400 p-4 rounded-xl shadow-inner">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-sm font-semibold text-orange-700">Available Balance:</p>
                    <button onclick="simulateReinvest(MOCK_AVAILABLE_BALANCE)" id="reinvestButton"
                            class="bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full hover:bg-blue-600 transition disabled:opacity-50">
                        Re-invest All
                    </button>
                </div>
                <span class="text-3xl font-extrabold text-orange-600">450.75 USDT</span>
                <p class="text-xs text-gray-500 mt-2">Min. Withdrawal: 10 USDT | Fee: 5%</p>
            </div>
            
            <div class="mb-5">
                <label for="withdrawalAmount" class="block text-sm font-semibold text-gray-700 mb-2">Amount to Withdraw (USDT)</label>
                <div class="relative rounded-xl shadow-inner border border-gray-200">
                    <input type="number" id="withdrawalAmount" placeholder="Min. 10 USDT" 
                           min="10" step="0.01"
                           oninput="calculateNetWithdrawal(this.value)"
                           class="input-usdt w-full p-4 pr-16 text-2xl font-bold text-gray-900 border-none bg-transparent focus:ring-orange-500 focus:border-orange-500 rounded-xl"
                           required>
                    <span class="absolute right-0 top-0 bottom-0 flex items-center pr-4 text-xl font-extrabold text-orange-600">USDT</span>
                </div>
            </div>

            <div class="bg-gray-50 border-l-4 border-gray-300 p-4 rounded-xl mb-5 shadow-inner">
                <p class="text-sm font-medium text-gray-700 flex items-center mb-1">
                    <i data-lucide="minus-circle" class="w-4 h-4 mr-2 text-red-500"></i> Net Fee (5.0%):
                    <span id="withdrawalFee" class="font-extrabold text-red-600 ml-1">0.00 USDT</span>
                </p>
                <p class="text-lg font-bold text-gray-900 flex items-center">
                    <i data-lucide="check-square" class="w-5 h-5 mr-2 text-green-600"></i> You Will Receive: 
                    <span id="netReceiveAmount" class="ml-1 text-2xl">0.00 USDT</span>
                </p>
            </div>
            
            <div class="mb-8">
                <label for="withdrawalAddress" class="block text-sm font-semibold text-gray-700 mb-2">USDT TRC20 Address</label>
                <input type="text" id="withdrawalAddress" placeholder="Enter your USDT TRC20 wallet address"
                       class="w-full p-3 border border-gray-300 rounded-xl shadow-inner text-gray-800 focus:ring-orange-500 focus:border-orange-500">
                <p id="tgUserLabel" class="text-xs text-gray-500 mt-1">Telegram ID (User_000000000): <span id="tgUserDisplay" class="font-medium text-gray-700">000000000</span></p>
            </div>

            <button onclick="simulateWithdrawal()" id="withdrawButton" disabled
                    class="w-full orange-gradient-button py-4 rounded-xl text-white font-extrabold text-lg shadow-lg opacity-50 cursor-not-allowed">
                <i data-lucide="wallet" class="w-5 h-5 mr-2 inline-block"></i> Confirm Withdrawal
            </button>

            <h3 class="text-xl font-bold text-gray-800 flex items-center mb-4 mt-8 border-t pt-4">
                <i data-lucide="list-ordered" class="w-5 h-5 mr-2 text-gray-500"></i> Withdrawal History
            </h3>
            <div class="overflow-x-auto rounded-xl shadow-md border border-gray-200">
                <table class="min-w-full text-left border-collapse">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700">Amount</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700">Date</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-center">Status/TXN</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawalHistoryBody">
                    </tbody>
                </table>
            </div>
            <div id="withdrawalHistoryPagination" class="flex justify-center items-center mt-6"></div>
        </section>

        <section id="dailyEarningHistoryView" data-view="daily-earning-history" class="hidden-view view bg-white p-6 rounded-3xl shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-6 border-b pb-3">
                <i data-lucide="history" class="w-6 h-6 mr-2 text-green-500"></i> Daily Earning History
            </h2>
            <div class="overflow-x-auto rounded-xl shadow-md border border-gray-200">
                <table class="min-w-full text-left border-collapse">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700">Date/Time</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-right">Earning</th>
                            <th class="py-3 px-4 text-xs font-bold text-gray-700 text-right">TP Rate</th>
                        </tr>
                    </thead>
                    <tbody id="dailyEarningHistoryBody">
                        </tbody>
                </table>
            </div>
            <div id="dailyEarningHistoryPagination" class="flex justify-center items-center mt-6"></div>
        </section>

    </div>

    <footer class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white border-t border-gray-200 shadow-2xl z-30">
        <div class="flex justify-around items-center h-16">
            <button onclick="navigateTo('dashboardView')" id="nav-dashboard" class="flex flex-col items-center justify-center text-sm font-medium text-blue-600 p-2 active-nav">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="mt-0.5 text-xs">Home</span>
            </button>
            <button onclick="navigateTo('buyTPView')" id="nav-buy-tp" class="flex flex-col items-center justify-center text-sm font-medium text-gray-500 hover:text-blue-500 p-2">
                <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                <span class="mt-0.5 text-xs">Buy TP</span>
            </button>
            <button onclick="navigateTo('referEarnView')" id="nav-refer-earn" class="flex flex-col items-center justify-center text-sm font-medium text-gray-500 hover:text-blue-500 p-2">
                <i data-lucide="gift" class="w-6 h-6"></i>
                <span class="mt-0.5 text-xs">Refer</span>
            </button>
            <button onclick="navigateTo('withdrawalView')" id="nav-withdrawal" class="flex flex-col items-center justify-center text-sm font-medium text-gray-500 hover:text-blue-500 p-2">
                <i data-lucide="banknote" class="w-6 h-6"></i>
                <span class="mt-0.5 text-xs">Withdraw</span>
            </button>
            <button onclick="navigateTo('introductionView')" id="nav-intro" class="flex flex-col items-center justify-center text-sm font-medium text-gray-500 hover:text-blue-500 p-2">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="mt-0.5 text-xs">About</span>
            </button>
        </div>
    </footer>

    <div id="message-container" class="fixed inset-0 z-50 pointer-events-none"></div>

    <script>
        // --- Global State and Constants ---
        const viewTitles = {
            dashboardView: 'AiEarn Dashboard',
            buyTPView: 'Buy Trade Power (TP)',
            buyTPHistoryView: 'TP Purchase History',
            referEarnView: 'Elite Referral Program',
            levelUsersView: 'Level Users',
            aiTradingStatusView: 'AI Trading Status',
            myTradePowerView: 'My Trade Power',
            introductionView: 'Company Profile',
            withdrawalView: 'Request Withdrawal',
            dailyEarningHistoryView: 'Daily Earning History',
            weekendEarnView: 'WEEKEND EARN FAST',
            weekendEarnHistoryView: 'Weekend Earn History'
        };
        let currentPage = 'dashboardView';
        const views = {};
        const itemsPerPage = 10;
        let withdrawalHistoryCurrentPage = 1;
        let buyTPHistoryCurrentPage = 1;
        let dailyEarningHistoryCurrentPage = 1;
        let weekendEarnHistoryCurrentPage = 1;
        let TG_USER_ID = '000000000'; // Default
        let TG_USERNAME = 'User_000000000';
        const TELEGRAM_BOT_USERNAME = 'AproveDappBot';
        let TG_INIT_DATA = null;

        // --- Mock Data / State Variables (Referral Data Updated) ---
        let hasInvestedThisWeek = false; 
        let MOCK_AVAILABLE_BALANCE = 450.75; 
        const mockUserTPPackages = [
            { id: 1, amount: 100, daysTotal: 20, activeDays: 15, dailyEarning: 0.060 },
            { id: 2, amount: 300, daysTotal: 20, activeDays: 20, dailyEarning: 0.065 }, // Expired
            { id: 3, amount: 1000, daysTotal: 20, activeDays: 5, dailyEarning: 0.070 }
        ];

        function generateMockData(count, factory) {
            const data = [];
            for (let i = 1; i <= count; i++) {
                data.push(factory(i));
            }
            return data;
        }

        const mockWithdrawalHistory = generateMockData(25, (i) => ({
            id: i,
            amount: [25, 50, 100, 200][i % 4] + (Math.floor(Math.random() * 5) + 1),
            date: `2025-11-${String(30 - i).padStart(2, '0')}`,
            status: i % 5 === 0 ? 'Pending' : 'Completed',
            txn: i % 5 === 0 ? 'TBD' : `0x${Math.random().toString(16).slice(2, 10)}...`
        }));

        const mockBuyTPHistory = generateMockData(30, (i) => {
            const amount = [10, 50, 100, 300, 1000][i % 5];
            const date = `2025-10-${String(30 - i).padStart(2, '0')}`;
            const dailyEarning = getRoiDetails(amount).rate;
            return {
                id: i,
                amount: amount,
                date: date,
                dailyEarning: dailyEarning
            };
        });

        const mockDailyEarningHistory = generateMockData(45, (i) => {
            const rate = [0.055, 0.060, 0.065, 0.070][i % 4];
            const date = `2025-11-${String(30 - i).padStart(2, '0')}`;
            const totalTP = [500, 1000, 2000][i % 3];
            return {
                id: i,
                date: date,
                earning: (totalTP * rate / 20).toFixed(4), 
                rate: (rate * 100).toFixed(1) + '%'
            };
        });

        const mockWeekendEarnHistory = generateMockData(10, (i) => {
            const amount = [100, 200, 500][i % 3];
            const returnAmount = (amount * 0.3).toFixed(2);
            const status = i % 3 === 0 ? 'Pending' : 'Completed';
            return {
                id: i,
                amount: amount,
                returnAmount: parseFloat(returnAmount),
                date: `2025-11-${String(15 - i * 2).padStart(2, '0')} 18:00:00`,
                status: status
            };
        });
        
        const mockReferralData = [
            { level: 1, commissionRate: '8%', users: 12, deposited: 8500.00, earned: 850.00 },
            { level: 2, commissionRate: '5%', users: 25, deposited: 12000.00, earned: 450.00 },
            { level: 3, commissionRate: '3%', users: 40, deposited: 15000.00, earned: 35.00 },
            { level: 4, commissionRate: '2%', users: 50, deposited: 10000.00, earned: 0.00 },
            { level: 5, commissionRate: '1%', users: 80, deposited: 20000.00, earned: 0.00 },
            { level: 6, commissionRate: '0.5%', users: 100, deposited: 30000.00, earned: 0.00 },
            { level: 7, commissionRate: '0.3%', users: 120, deposited: 40000.00, earned: 0.00 },
            { level: 8, commissionRate: '0.2%', users: 150, deposited: 50000.00, earned: 0.00 },
            { level: 9, commissionRate: '0.1%', users: 180, deposited: 60000.00, earned: 0.00 },
            { level: 10, commissionRate: '0.1%', users: 200, deposited: 70000.00, earned: 0.00 },
        ];
        
        // ====================================================================
        // --- 1. LIVE DATA CONFIGURATION AND HELPER FUNCTIONS (Updated) ---
        // ====================================================================

        let isAITradingLoopRunning = false; 
        const API_URL = 'https://api.binance.com/api/v3/ticker/24hr';
        const STORAGE_KEY = 'virtualLeveragedPositions_30min'; 
        const UPDATE_INTERVAL_MS = 30 * 60 * 1000; 
        const REFRESH_INTERVAL_MS = 60000; 

        function getRandomEntryPrice(lowPrice, highPrice) {
            const min = parseFloat(lowPrice);
            const max = parseFloat(highPrice);
            // Entry price is set randomly within 30% to 70% range of the 24hr spread
            const randomFactor = Math.random() * (0.7 - 0.3) + 0.3; 
            return (min + (max - min) * randomFactor);
        }

        function getRandomLeverage() {
            // Random leverage between 5 and 30
            return Math.floor(Math.random() * (30 - 5 + 1)) + 5; 
        }

        function calculateBasePNL(currentPrice, entryPrice, tradeType) {
            let pnl;
            if (tradeType === 'LONG') {
                pnl = ((currentPrice - entryPrice) / entryPrice) * 100;
            } else { // SHORT
                pnl = ((entryPrice - currentPrice) / entryPrice) * 100;
            }
            return pnl;
        }

        function getProfitableTradeType(currentPrice, entryPrice) {
            // If current price > entry, LONG is profitable
            if (currentPrice > entryPrice) {
                return 'LONG';
            } else { // If current price < entry, SHORT is profitable
                return 'SHORT';
            }
        }


        // ====================================================================
        // --- 2. LIVE DATA FETCH AND CALCULATION CORE (Updated to show only profit) ---
        // ====================================================================

        async function fetchAndCalculatePNL() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                // Filter for top 15 USDT pairs by quote volume
                const pairsToTrack = data
                    .filter(pair => pair.symbol.endsWith('USDT'))
                    .sort((a, b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
                    .slice(0, 15);

                let positionData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
                const now = new Date().getTime();
                const updatedPositionData = {};
                
                // Update/Generate new virtual entry positions every 30 minutes
                pairsToTrack.forEach(pair => {
                    const symbol = pair.symbol;
                    const lowPrice = parseFloat(pair.lowPrice);
                    const highPrice = parseFloat(pair.highPrice);

                    if (positionData[symbol] && (now - positionData[symbol].timestamp < UPDATE_INTERVAL_MS)) {
                        updatedPositionData[symbol] = positionData[symbol];
                    } else {
                        updatedPositionData[symbol] = {
                            entryPrice: getRandomEntryPrice(lowPrice, highPrice),
                            leverage: getRandomLeverage(),
                            timestamp: now,
                            time_string: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'UTC' }) + ' UTC'
                        };
                    }
                });

                localStorage.setItem(STORAGE_KEY, JSON.stringify(updatedPositionData));
                positionData = updatedPositionData;

                // Calculate PNL based on current price and stored entry price
                const calculatedResults = pairsToTrack.map((pair, index) => {
                    const lastPrice = parseFloat(pair.lastPrice);
                    const entryPrice = positionData[pair.symbol].entryPrice;
                    const leverage = positionData[pair.symbol].leverage;
                    const time_string = positionData[pair.symbol].time_string;
                    
                    // 1. Determine the trade type that is PROFITABLE
                    const profitableTradeType = getProfitableTradeType(lastPrice, entryPrice);
                    
                    // 2. Calculate the base PNL (which will be positive)
                    const basePNL = calculateBasePNL(lastPrice, entryPrice, profitableTradeType);
                    
                    // 3. Calculate the leveraged PNL (guaranteed positive)
                    // Added a slight random positive multiplier (1x to 2x) for more dynamic profit
                    const finalLeveragedPNL = basePNL * leverage * (Math.random() + 1); 
                    
                    const symbol = pair.symbol.replace('USDT', '/USDT');

                    return {
                        id: index + 1,
                        symbol: symbol, 
                        currentPrice: lastPrice.toFixed(4),
                        entryPrice: entryPrice.toFixed(4),
                        position: profitableTradeType, // LONG or SHORT
                        leverage: leverage,
                        leveragedPNL: finalLeveragedPNL.toFixed(2), 
                        time: time_string
                    };
                });

                // Filter out any potential zero or near-zero results (shouldn't happen with the current logic, but as a safeguard)
                return calculatedResults.filter(item => parseFloat(item.leveragedPNL) > 0.05).slice(0, 10); 

            } catch (error) {
                console.error("Error fetching or calculating data:", error);
                return [];
            }
        }


        // ====================================================================
        // --- Core Functions (General) ---
        // ====================================================================

        function showMessage(title, message, type = 'info') {
            const container = document.getElementById('message-container');
            const colorMap = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500',
                'warning': 'bg-yellow-500'
            };

            const iconMap = {
                'success': 'check-circle',
                'error': 'x-circle',
                'info': 'info',
                'warning': 'alert-triangle'
            };

            const toast = document.createElement('div');
            toast.className = `fixed bottom-20 left-1/2 -translate-x-1/2 mb-4 w-11/12 max-w-sm ${colorMap[type]} text-white p-4 rounded-xl shadow-2xl transition-all duration-500 ease-out opacity-0 translate-y-4 pointer-events-auto`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="${iconMap[type]}" class="w-5 h-5 mr-3 flex-shrink-0"></i>
                    <div>
                        <p class="font-bold text-lg">${title}</p>
                        <p class="text-sm">${message}</p>
                    </div>
                </div>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-4');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
            
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred(type === 'success' ? 'success' : (type === 'error' ? 'error' : 'warning'));
            }
        }

        function getRoiDetails(amount) {
            const investment = parseFloat(amount);
            if (isNaN(investment)) return { rate: 0, label: '0%', factor: 0 };
            
            if (investment >= 3000) {
                return { rate: 0.070, label: '7.0%', factor: 140 };
            } else if (investment >= 300) {
                return { rate: 0.065, label: '6.5%', factor: 130 };
            } else if (investment >= 20) {
                return { rate: 0.060, label: '6.0%', factor: 120 };
            } else if (investment >= 0) {
                return { rate: 0.055, label: '5.5%', factor: 110 };
            } else {
                return { rate: 0, label: '0%', factor: 0 };
            }
        }

        const usdtAmountInput = document.getElementById('usdtAmount');
        const dailyRateDisplay = document.getElementById('dailyRateDisplay');
        const dailyReturnAmount = document.getElementById('dailyReturnAmount');
        const buyNowButton = document.getElementById('buyNowButton');
        const MIN_INVEST = 10;

        function calculateReturn(usdtValue) {
            const amount = parseFloat(usdtValue);
            const roi = getRoiDetails(amount);

            if (isNaN(amount) || amount < MIN_INVEST) {
                dailyRateDisplay.textContent = '0%';
                dailyReturnAmount.textContent = '0.00 USDT';
                buyNowButton.disabled = true;
                buyNowButton.classList.add('opacity-50', 'cursor-not-allowed');
                buyNowButton.classList.remove('hover:opacity-95');
                buyNowButton.innerHTML = `<i data-lucide="lock" class="w-5 h-5 mr-2 inline-block"></i> Buy Now (Min ${MIN_INVEST} USDT)`;
                lucide.createIcons();
                return;
            }

            const dailyReturn = amount * (roi.rate / 20); 
            dailyRateDisplay.textContent = roi.label;
            dailyReturnAmount.textContent = `${dailyReturn.toFixed(4)} USDT`;
            buyNowButton.disabled = false;
            buyNowButton.classList.remove('opacity-50', 'cursor-not-allowed');
            buyNowButton.classList.add('hover:opacity-95');
            buyNowButton.innerHTML = `<i data-lucide="zap" class="w-5 h-5 mr-2 inline-block"></i> Confirm Purchase (${amount.toFixed(2)} USDT)`;
            lucide.createIcons();
        }

        function simulateGateway() {
            const amount = parseFloat(usdtAmountInput.value);
            if (isNaN(amount) || amount < MIN_INVEST) {
                showMessage('Error', `Minimum investment is ${MIN_INVEST} USDT.`, 'error');
                return;
            }

            showMessage('Processing...', 'Redirecting to payment gateway...', 'info');

            setTimeout(() => {
                const roi = getRoiDetails(amount);
                mockBuyTPHistory.unshift({ 
                    id: mockBuyTPHistory.length + 1,
                    amount: amount,
                    date: new Date().toISOString().split('T')[0],
                    dailyEarning: roi.rate
                });
                
                const newTPPackage = { 
                    id: mockUserTPPackages.length + 1, 
                    amount: amount, 
                    daysTotal: 20, 
                    activeDays: 0, 
                    dailyEarning: roi.rate 
                };
                mockUserTPPackages.push(newTPPackage);

                usdtAmountInput.value = '';
                calculateReturn(0); 

                const newTP = amount / 200; 
                showMessage('TP Purchased!', `Successfully bought ${newTP.toFixed(2)} TP with ${amount.toFixed(2)} USDT! Your new daily ROI is ${roi.label}.`, 'success');
                navigateTo('dashboardView');
            }, 2000);
        }

        const withdrawalAmountInput = document.getElementById('withdrawalAmount');
        const withdrawalAddressInput = document.getElementById('withdrawalAddress');
        const netReceiveAmount = document.getElementById('netReceiveAmount');
        const withdrawalFee = document.getElementById('withdrawalFee');
        const withdrawButton = document.getElementById('withdrawButton');
        const MIN_WITHDRAWAL = 1;
        const WITHDRAWAL_FEE_RATE = 0.05; 

        function calculateNetWithdrawal(usdtValue) {
            const amount = parseFloat(usdtValue);
            
            if (isNaN(amount) || amount < MIN_WITHDRAWAL || amount > MOCK_AVAILABLE_BALANCE) {
                withdrawalFee.textContent = '0.00 USDT';
                netReceiveAmount.textContent = '0.00 USDT';
                withdrawButton.disabled = true;
                withdrawButton.classList.add('opacity-50', 'cursor-not-allowed');
                withdrawButton.innerHTML = `<i data-lucide="lock" class="w-5 h-5 mr-2 inline-block"></i> Confirm Withdrawal`;
                return;
            }

            const fee = amount * WITHDRAWAL_FEE_RATE;
            const netReceive = amount - fee;

            withdrawalFee.textContent = `${fee.toFixed(2)} USDT`;
            netReceiveAmount.textContent = `${netReceive.toFixed(2)} USDT`;
            withdrawButton.disabled = false;
            withdrawButton.classList.remove('opacity-50', 'cursor-not-allowed');
            withdrawButton.innerHTML = `<i data-lucide="wallet" class="w-5 h-5 mr-2 inline-block"></i> Confirm Withdrawal (${netReceive.toFixed(2)} USDT)`;
            lucide.createIcons();
        }

        function simulateWithdrawal() {
            const amount = parseFloat(withdrawalAmountInput.value);
            const address = withdrawalAddressInput.value.trim();

            if (isNaN(amount) || amount < MIN_WITHDRAWAL) {
                showMessage('Error', `Minimum withdrawal amount is ${MIN_WITHDRAWAL} USDT.`, 'error');
                return;
            }
            if (amount > MOCK_AVAILABLE_BALANCE) {
                showMessage('Error', `Insufficient balance. Available: ${MOCK_AVAILABLE_BALANCE.toFixed(2)} USDT.`, 'error');
                return;
            }
            if (address.length < 30) {
                showMessage('Error', 'Please enter a valid USDT TRC20 address.', 'error');
                return;
            }

            const fee = amount * WITHDRAWAL_FEE_RATE;
            const netReceive = amount - fee;
            
            MOCK_AVAILABLE_BALANCE -= amount;
            
            mockWithdrawalHistory.unshift({
                id: mockWithdrawalHistory.length + 1,
                amount: netReceive,
                date: new Date().toISOString().split('T')[0],
                status: 'Pending',
                txn: 'TBD'
            });

            withdrawalAmountInput.value = '';
            withdrawalAddressInput.value = '';
            calculateNetWithdrawal(0);
            document.querySelector('#withdrawalView .text-3xl.font-extrabold.text-orange-600').textContent = `${MOCK_AVAILABLE_BALANCE.toFixed(2)} USDT`;
            renderWithdrawalHistory(1);

            showMessage('Withdrawal Request Sent!', `You requested ${netReceive.toFixed(2)} USDT. Processing...`, 'success');
        }

        function simulateReinvest(amount) {
            const minReinvest = 10;
            const newBalance = 0;
            if (amount < minReinvest) {
                showMessage('Re-invest Error', `Minimum re-investment amount is ${minReinvest} USDT. Available: ${amount.toFixed(2)} USDT.`, 'error');
                return;
            }
            
            const roi = getRoiDetails(amount); 
            
            const newTPPackage = { 
                id: mockUserTPPackages.length + 1, 
                amount: amount, 
                daysTotal: 20, 
                activeDays: 0, 
                dailyEarning: roi.rate 
            };
            mockUserTPPackages.push(newTPPackage);

            MOCK_AVAILABLE_BALANCE = newBalance;
            
            document.querySelector('#withdrawalView .text-3xl.font-extrabold.text-orange-600').textContent = `${MOCK_AVAILABLE_BALANCE.toFixed(2)} USDT`;
            
            const reinvestBtn = document.getElementById('reinvestButton');
            if (reinvestBtn) {
                reinvestBtn.disabled = true;
                reinvestBtn.classList.add('opacity-50');
            }

            showMessage(
                'TP Re-investment Successful', 
                `Successfully re-invested ${amount.toFixed(2)} USDT into Trade Power (TP). Your daily earnings will increase!`,
                'success'
            );
            
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }

        const weekendAmountInput = document.getElementById('weekendAmount');
        const weekendBuyButton = document.getElementById('weekendBuyButton');
        const weekendRateDisplay = document.getElementById('weekendRateDisplay');
        const weekendReturnAmount = document.getElementById('weekendReturnAmount');
        const WEEKEND_RATE = 0.30;
        const WEEKEND_MIN_INVEST = 100;
        const weekendDashboardButton = document.getElementById('weekendDashboardButton');
        const restrictionText = document.getElementById('weekendRestrictionText');

        function calculateWeekendReturn(usdtValue) {
            const amount = parseFloat(usdtValue);
            const minInvest = WEEKEND_MIN_INVEST;
            
            if (hasInvestedThisWeek) { 
                weekendRateDisplay.textContent = '30%';
                weekendReturnAmount.textContent = '0.00 USDT';
                weekendBuyButton.disabled = true;
                return;
            }

            if (isNaN(amount) || amount < minInvest) {
                weekendRateDisplay.textContent = '30%';
                weekendReturnAmount.textContent = '0.00 USDT';
                weekendBuyButton.disabled = true;
                weekendBuyButton.classList.add('opacity-50', 'cursor-not-allowed');
                weekendBuyButton.classList.remove('hover:opacity-95');
                weekendBuyButton.innerHTML = `<i data-lucide="lock" class="w-5 h-5 mr-2 inline-block"></i> Invest Now (Min ${minInvest} USDT)`;
                lucide.createIcons();
                return;
            }

            const totalReturn = amount * WEEKEND_RATE;
            weekendReturnAmount.textContent = `${totalReturn.toFixed(4)} USDT`;
            weekendBuyButton.disabled = false;
            weekendBuyButton.classList.remove('opacity-50', 'cursor-not-allowed');
            weekendBuyButton.classList.add('hover:opacity-95');
            weekendBuyButton.innerHTML = `<i data-lucide="zap" class="w-5 h-5 mr-2 inline-block"></i> Confirm Investment (${amount.toFixed(2)} USDT)`;
            lucide.createIcons();
        }

        function simulateWeekendGateway() {
            const amount = parseFloat(weekendAmountInput.value);
            const minInvest = WEEKEND_MIN_INVEST;

            if (isNaN(amount) || amount < minInvest) {
                showMessage('Error', `Minimum investment is ${minInvest} USDT.`, 'error');
                return;
            }
            if (hasInvestedThisWeek) {
                showMessage('Error', 'You have already invested this week.', 'error');
                return;
            }

            showMessage('Processing...', 'Redirecting to payment gateway for Weekend Earn...', 'info');

            setTimeout(() => {
                const totalReturn = amount * WEEKEND_RATE;
                
                mockWeekendEarnHistory.unshift({ 
                    id: mockWeekendEarnHistory.length + 1,
                    amount: amount,
                    returnAmount: totalReturn,
                    date: new Date().toISOString().split('T')[0] + ' 18:00:00',
                    status: 'Pending'
                });
                
                hasInvestedThisWeek = true;
                localStorage.setItem('hasInvestedThisWeek', 'true');

                weekendAmountInput.value = '';
                checkWeekendEligibility();
                
                showMessage('Investment Successful!', `You invested ${amount.toFixed(2)} USDT. Est. Return: ${totalReturn.toFixed(2)} USDT in 48 hours.`, 'success');
                navigateTo('weekendEarnHistoryView');
            }, 2000);
        }

        function checkWeekendEligibility() {
            const storedState = localStorage.getItem('hasInvestedThisWeek');
            hasInvestedThisWeek = storedState === 'true'; 
            const minInvest = WEEKEND_MIN_INVEST;

            if (weekendDashboardButton) {
                if (hasInvestedThisWeek) {
                    weekendDashboardButton.setAttribute('disabled', 'true');
                    weekendDashboardButton.textContent = 'INVESTED';
                    weekendDashboardButton.classList.remove('bg-yellow-400', 'hover:bg-yellow-500');
                    weekendDashboardButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                } else {
                    weekendDashboardButton.removeAttribute('disabled');
                    weekendDashboardButton.textContent = "LET'S GO";
                    weekendDashboardButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    weekendDashboardButton.classList.add('bg-yellow-400', 'hover:bg-yellow-500');
                }
            }

            if (currentPage === 'weekendEarnView') {
                if (hasInvestedThisWeek) {
                    weekendAmountInput.setAttribute('disabled', 'true');
                    weekendAmountInput.placeholder = 'Already invested this week';
                    weekendBuyButton.setAttribute('disabled', 'true');
                    weekendBuyButton.classList.add('opacity-50', 'cursor-not-allowed');
                    weekendBuyButton.classList.remove('hover:opacity-95');
                    weekendBuyButton.innerHTML = '<i data-lucide="x-circle" class="w-5 h-5 mr-2 inline-block"></i> Weekly Limit Reached';
                    restrictionText.innerHTML = `<span class="font-bold text-red-500">ðŸš« Weekly Limit Reached:</span> You must wait until next week to invest again. (Minimum ${minInvest} USDT)`;
                } else {
                    weekendAmountInput.removeAttribute('disabled');
                    weekendAmountInput.placeholder = `Min. ${minInvest} USDT`;
                    restrictionText.innerHTML = `Invest for a short-term, high-return opportunity. (Minimum ${minInvest} USDT, **Once per week**)`;
                    calculateWeekendReturn(weekendAmountInput.value);
                }
                lucide.createIcons();
            }
        }


        const referralTableBody = document.getElementById('referralTableBody');
        const levelUsersTitle = document.getElementById('levelUsersTitle');
        const levelUsersList = document.getElementById('levelUsersList');
        const referralLinkInput = document.getElementById('referralLink');

        function populateReferralTable() {
            let html = '';
            mockReferralData.forEach(data => {
                const isHighlighted = data.level === 1;
                html += `
                    <tr class="border-b border-gray-100 ${isHighlighted ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50'}">
                        <td class="py-3 px-4 text-xs font-bold text-gray-800">${data.level} <span class="block text-gray-500 text-[10px]">${data.commissionRate} Comm.</span></td>
                        <td class="py-3 px-4 text-xs text-center font-medium text-gray-600">${data.users + (parseInt(TG_USER_ID.slice(-3)) % 10)}</td>
                        <td class="py-3 px-4 text-xs text-right font-medium text-gray-600">$${data.deposited.toLocaleString()}</td>
                        <td class="py-3 px-4 text-xs text-right font-bold text-green-600">$${data.earned.toLocaleString()}</td>
                        <td class="py-3 px-4 text-xs text-center">
                            <button onclick="navigateTo('levelUsersView', ${data.level})" class="text-blue-500 hover:text-blue-700 font-semibold">View</button>
                        </td>
                    </tr>
                `;
            });
            referralTableBody.innerHTML = html;
            lucide.createIcons();
        }

        function showLevelUsers(level) {
            levelUsersTitle.innerHTML = `<i data-lucide="users" class="w-6 h-6 mr-2 text-blue-500"></i> Users in Level ${level}`;
            
            let usersHtml = `<p class="text-sm font-semibold text-gray-700">Total Users: ${mockReferralData[level - 1].users + (parseInt(TG_USER_ID.slice(-3)) % 10)}</p><hr class="my-3">`;

            const totalUsers = mockReferralData[level - 1].users + (parseInt(TG_USER_ID.slice(-3)) % 10);
            const mockNames = ['Aman S.', 'Priya K.', 'Vikram R.', 'Neha J.', 'Karan M.', 'Sonal B.', 'Rajesh P.', 'Anil D.', 'Kiran B.', 'Zoya F.'];
            
            for (let i = 1; i <= Math.min(totalUsers, 15); i++) {
                const userName = mockNames[(i + level * 2) % mockNames.length];
                const deposit = (100 + (i * 50) * Math.random()).toFixed(2);
                let referrerDisplay;

                if (level === 1) {
                    referrerDisplay = `<p class="text-xs text-blue-500 font-bold">Referred by: You (${TG_USERNAME})</p>`;
                } else {
                    const referrerName = mockNames[(i + level * 3) % mockNames.length] + ' (L' + (level - 1) + ')';
                    referrerDisplay = `<p class="text-xs text-blue-500 font-bold">Referred by: ${referrerName}</p>`;
                }

                usersHtml += `
                    <div class="p-4 bg-gray-50 rounded-xl shadow-inner flex justify-between items-center border border-gray-200">
                        <div>
                            <p class="font-semibold text-gray-800">${userName} (ID: ${1000 + i + level * 100})</p>
                            ${referrerDisplay}
                            <p class="text-xs text-gray-500">Joined: 2025-10-${String(i).padStart(2, '0')}</p>
                        </div>
                        <span class="font-bold text-lg text-green-600">$${deposit}</span>
                    </div>
                `;
            }
            
            levelUsersList.innerHTML = usersHtml;
            lucide.createIcons();
            navigateTo('levelUsersView');
        }

        function copyReferralLink() {
            const link = referralLinkInput.value;
            navigator.clipboard.writeText(link).then(() => {
                showMessage('Copied!', 'Referral link copied to clipboard.', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showMessage('Error', 'Failed to copy link. Try manually.', 'error');
            });
        }


        function renderPaginationControls(totalItems, itemsPerPage, currentPage, targetViewId, paginationContainerId, setPageFn) {
            const container = document.getElementById(paginationContainerId);
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            container.innerHTML = '';

            if (totalPages <= 1) return;

            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            
            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            let prevButton = document.createElement('button');
            prevButton.className = 'pagination-button bg-gray-200 text-gray-700';
            prevButton.disabled = currentPage === 1;
            prevButton.innerHTML = '<i data-lucide="chevron-left" class="w-4 h-4"></i>';
            prevButton.onclick = () => {
                setPageFn(currentPage - 1);
                navigateTo(targetViewId);
            };
            container.appendChild(prevButton);

            for (let i = startPage; i <= endPage; i++) {
                let button = document.createElement('button');
                button.className = `pagination-button ${i === currentPage ? 'active' : 'bg-gray-200 text-gray-700'}`;
                button.textContent = i;
                button.onclick = () => {
                    setPageFn(i);
                    navigateTo(targetViewId);
                };
                container.appendChild(button);
            }

            let nextButton = document.createElement('button');
            nextButton.className = 'pagination-button bg-gray-200 text-gray-700';
            nextButton.disabled = currentPage === totalPages;
            nextButton.innerHTML = '<i data-lucide="chevron-right" class="w-4 h-4"></i>';
            nextButton.onclick = () => {
                setPageFn(currentPage + 1);
                navigateTo(targetViewId);
            };
            container.appendChild(nextButton);
            
            lucide.createIcons();
        }

        function renderWithdrawalRow(item) {
            const statusColor = item.status === 'Completed' ? 'text-green-600' : 'text-orange-500';
            const statusIcon = item.status === 'Completed' ? 'check-circle' : 'loader';
            const txnDisplay = item.status === 'Completed' ? item.txn : 'In Progress';
            return `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4 text-sm font-bold text-red-600 text-right">-$${item.amount.toFixed(2)}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${item.date}</td>
                    <td class="py-3 px-4 text-xs text-center">
                        <span class="font-semibold ${statusColor} flex flex-col items-center justify-center">
                            <i data-lucide="${statusIcon}" class="w-3 h-3 mb-0.5"></i>
                            ${txnDisplay}
                        </span>
                    </td>
                </tr>
            `;
        }

        function renderBuyTPRow(item) {
            return `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4 text-sm text-gray-600">${item.date}</td>
                    <td class="py-3 px-4 text-sm font-bold text-green-600 text-right">+$${item.amount.toFixed(2)}</td>
                    <td class="py-3 px-4 text-sm font-medium text-purple-600 text-right">${(item.dailyEarning * 100).toFixed(1)}%</td>
                </tr>
            `;
        }

        function renderDailyEarningRow(item) {
            return `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4 text-sm text-gray-600">${item.date}</td>
                    <td class="py-3 px-4 text-sm font-bold text-green-600 text-right">+$${item.earning}</td>
                    <td class="py-3 px-4 text-sm font-medium text-purple-600 text-right">${item.rate}</td>
                </tr>
            `;
        }

        function renderWeekendEarnRow(item) {
            const statusColor = item.status === 'Completed' ? 'text-green-600' : 'text-orange-500';
            const statusIcon = item.status === 'Completed' ? 'check-circle' : 'clock';
            const totalReturn = item.amount + item.returnAmount;
            return `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4 text-sm text-gray-600">${item.date}</td>
                    <td class="py-3 px-4 text-sm font-bold text-red-600 text-right">$${item.amount.toFixed(2)}</td>
                    <td class="py-3 px-4 text-sm font-bold text-green-600 text-right">
                        + $${item.returnAmount.toFixed(2)} <span class="block text-gray-400 text-[10px]">Total: $${totalReturn.toFixed(2)}</span>
                    </td>
                    <td class="py-3 px-4 text-xs text-center">
                        <span class="font-semibold ${statusColor} flex items-center justify-center">
                            <i data-lucide="${statusIcon}" class="w-3 h-3 mr-1"></i> ${item.status}
                        </span>
                    </td>
                </tr>
            `;
        }

        function renderWithdrawalHistory(page) {
            const body = document.getElementById('withdrawalHistoryBody');
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = mockWithdrawalHistory.slice(startIndex, endIndex);
            body.innerHTML = paginatedItems.map(renderWithdrawalRow).join('');
            renderPaginationControls(
                mockWithdrawalHistory.length,
                itemsPerPage,
                page,
                'withdrawalView',
                'withdrawalHistoryPagination',
                (p) => withdrawalHistoryCurrentPage = p
            );
            lucide.createIcons();
        }

        function renderBuyTPHistory(page) {
            const body = document.getElementById('buyTPHistoryBody');
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = mockBuyTPHistory.slice(startIndex, endIndex);
            body.innerHTML = paginatedItems.map(renderBuyTPRow).join('');
            renderPaginationControls(
                mockBuyTPHistory.length,
                itemsPerPage,
                page,
                'buyTPHistoryView',
                'buyTPHistoryPagination',
                (p) => buyTPHistoryCurrentPage = p
            );
            lucide.createIcons();
        }

        function renderDailyEarningHistory(page) {
            const body = document.getElementById('dailyEarningHistoryBody');
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = mockDailyEarningHistory.slice(startIndex, endIndex);
            body.innerHTML = paginatedItems.map(renderDailyEarningRow).join('');
            renderPaginationControls(
                mockDailyEarningHistory.length,
                itemsPerPage,
                page,
                'dailyEarningHistoryView',
                'dailyEarningHistoryPagination',
                (p) => dailyEarningHistoryCurrentPage = p
            );
            lucide.createIcons();
        }

        function renderWeekendEarnHistory(page) {
            const body = document.getElementById('weekendEarnHistoryBody');
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = mockWeekendEarnHistory.slice(startIndex, endIndex);
            body.innerHTML = paginatedItems.map(renderWeekendEarnRow).join('');
            renderPaginationControls(
                mockWeekendEarnHistory.length,
                itemsPerPage,
                page,
                'weekendEarnHistoryView',
                'weekendEarnHistoryPagination',
                (p) => weekendEarnHistoryCurrentPage = p
            );
            lucide.createIcons();
        }
        
        function renderMyTradePower() {
            const listContainer = document.getElementById('myTPPackagesList');
            let html = mockUserTPPackages.map(item => {
                const daysRemaining = Math.max(0, item.daysTotal - item.activeDays);
                const percentage = Math.min(100, (item.activeDays / item.daysTotal) * 100);
                const progressColor = percentage < 100 ? 'bg-blue-500' : 'bg-red-500';
                const statusLabel = daysRemaining > 0 ? `${daysRemaining} Days Left` : 'Expired!';
                const statusColor = daysRemaining > 0 ? 'text-green-600' : 'text-red-600';
                const cardBorder = daysRemaining > 0 ? 'border-green-300' : 'border-red-300';
                
                const dailyReturn = (item.amount * item.dailyEarning).toFixed(4);

                return `
                    <div class="bg-white p-5 rounded-2xl shadow-xl border-t-8 ${cardBorder} space-y-3">
                        <div class="flex justify-between items-center border-b pb-3">
                            <h3 class="text-2xl font-extrabold text-gray-800">
                                $${item.amount.toLocaleString()} <span class="text-sm font-medium text-gray-500">TP Package</span>
                            </h3>
                            <span class="font-bold text-lg ${statusColor} bg-gray-100 px-3 py-1 rounded-full">${statusLabel}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm font-medium">
                            <div class="flex items-center text-gray-700">
                                <i data-lucide="zap" class="w-4 h-4 mr-1 text-green-500"></i> Daily ROI: <span class="font-bold text-green-600 ml-1">${(item.dailyEarning * 100).toFixed(1)}%</span>
                            </div>
                            <div class="flex items-center text-gray-700">
                                <i data-lucide="dollar-sign" class="w-4 h-4 mr-1 text-purple-500"></i> Daily $ Return: <span class="font-bold text-purple-600 ml-1">$${dailyReturn}</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="${progressColor} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>Started: ${item.activeDays} days ago</span>
                            <span>Total Duration: ${item.daysTotal} days</span>
                        </div>
                    </div>
                `;
            }).join('');

            if (mockUserTPPackages.length === 0) {
                html = `<p class="text-center text-gray-500 py-10">No active Trade Power packages found. <br> <a href="javascript:void(0)" onclick="navigateTo('buyTPView')" class="text-blue-500 font-semibold">Buy TP Now!</a></p>`;
            }
            
            listContainer.innerHTML = html;
            lucide.createIcons();
        }

        // ====================================================================
        // --- 3. TABLE RENDERING AND LOOP MANAGEMENT (Updated for Premium Look) ---
        // ====================================================================

        function updateAITradingStatusTable(data) {
            const tableBody = document.getElementById('aiTradingHistoryBody'); 
            if (!tableBody) return;

            tableBody.innerHTML = ''; 

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No profitable trades detected in the last hour.</td></tr>`;
                return;
            }
            
            data.forEach(item => {
                const pnlValue = parseFloat(item.leveragedPNL); 
                
                // Position Arrow and Color
                const positionClass = item.position === 'LONG' ? 'text-green-500' : 'text-red-500';
                const icon = item.position === 'LONG' ? 'arrow-up-right' : 'arrow-down-right'; 
                const iconClass = item.position === 'LONG' ? 'bg-green-100' : 'bg-red-100';

                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 last:border-b-0 transition-colors hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-3 text-sm font-medium flex items-center">
                        <span class="mr-2 text-base font-bold text-gray-900">${item.symbol}</span>
                        <span class="${positionClass} flex items-center font-extrabold text-xs ${iconClass} px-2 py-0.5 rounded-full border border-gray-200">
                            <i data-lucide="${icon}" class="w-3 h-3 mr-1"></i> ${item.leverage}
                        </span>
                    </td>
                    
                    <td class="py-3 px-1 text-xs text-gray-500 text-center font-medium">
                        ${item.entryPrice}
                        <span class="block font-semibold text-gray-800 text-sm">${item.currentPrice}</span>
                    </td>
                    
                    <td class="py-3 px-3 pnl-cell font-extrabold text-green-600 text-right">
                        +${pnlValue.toFixed(2)}%
                    </td>
                    
                    <td class="py-3 px-1 text-xs text-gray-500 text-right font-medium" style="line-height: 1;">
                        ${item.time.substring(0, 5)}<span class="block text-[10px]">UTC</span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            lucide.createIcons();
        }

        async function startAITradingDataLoop() {
            const tableBody = document.getElementById('aiTradingHistoryBody');
            if (tableBody) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Loading Live Trading Data...</td></tr>`;
            }

            let data = await fetchAndCalculatePNL();
            updateAITradingStatusTable(data);
            
            if (!isAITradingLoopRunning) {
                isAITradingLoopRunning = true;
                setInterval(async () => {
                    let newData = await fetchAndCalculatePNL();
                    updateAITradingStatusTable(newData);
                }, REFRESH_INTERVAL_MS);
            }
        }

        function renderAITradingStatus() {
            startAITradingDataLoop();
        }

        // --- General View Navigation and UI Management ---
        function renderHeader(viewId) {
            const header = document.getElementById('header');
            let title = viewTitles[viewId] || 'AiEarn';
            let backButtonHtml = '';

            if (viewId !== 'dashboardView') {
                let backToView = 'dashboardView';
                if (viewId === 'levelUsersView') {
                    backToView = 'referEarnView';
                } else if (viewId === 'buyTPHistoryView') {
                    backToView = 'buyTPView';
                } else if (viewId === 'weekendEarnHistoryView') {
                    backToView = 'weekendEarnView';
                }
                
                backButtonHtml = `
                    <button onclick="navigateTo('${backToView}')" class="text-gray-500 hover:text-gray-700 p-2 rounded-full">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                `;
            }

            header.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        ${backButtonHtml}
                        <h1 class="text-xl font-bold text-gray-900 ml-2">${title}</h1>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function setActiveNav(viewId) {
            document.querySelectorAll('footer button').forEach(button => {
                button.classList.remove('active-nav', 'text-blue-600');
                button.classList.add('text-gray-500', 'hover:text-blue-500');
            });

            let targetId;
            if (viewId === 'dashboardView' || viewId === 'weekendEarnView' || viewId === 'dailyEarningHistoryView') {
                targetId = 'nav-dashboard';
            } else if (viewId === 'buyTPView' || viewId === 'buyTPHistoryView') {
                targetId = 'nav-buy-tp';
            } else if (viewId === 'referEarnView' || viewId === 'levelUsersView') {
                targetId = 'nav-refer-earn';
            } else if (viewId === 'withdrawalView') {
                targetId = 'nav-withdrawal';
            } else if (viewId === 'introductionView') {
                targetId = 'nav-intro';
            } else {
                return;
            }
            
            const targetButton = document.getElementById(targetId);
            if (targetButton) {
                targetButton.classList.add('active-nav', 'text-blue-600');
                targetButton.classList.remove('text-gray-500', 'hover:text-blue-500');
            }
        }

        function navigateTo(viewId, ...args) {
            currentPage = viewId;
            
            document.querySelectorAll('section[data-view]').forEach(view => {
                view.classList.remove('view');
                view.classList.add('hidden-view');
            });

            const targetView = views[viewId];
            if (targetView) {
                targetView.classList.remove('hidden-view');
                targetView.classList.add('view');
                window.scrollTo(0, 0); 
            }
            
            renderHeader(viewId);
            setActiveNav(viewId);

            if (viewId === 'dashboardView' || viewId === 'weekendEarnView') {
                checkWeekendEligibility();
            }
            if (viewId === 'referEarnView') {
                populateReferralTable();
            } else if (viewId === 'levelUsersView') {
                showLevelUsers(args[0]);
            } else if (viewId === 'weekendEarnHistoryView') {
                renderWeekendEarnHistory(weekendEarnHistoryCurrentPage);
            } else if (viewId === 'withdrawalView') {
                const balanceSpan = document.querySelector('#withdrawalView .text-3xl.font-extrabold.text-orange-600');
                if (balanceSpan) {
                    balanceSpan.textContent = `${MOCK_AVAILABLE_BALANCE.toFixed(2)} USDT`;
                }
                const reinvestBtn = document.getElementById('reinvestButton');
                if (reinvestBtn) {
                    reinvestBtn.disabled = MOCK_AVAILABLE_BALANCE < MIN_WITHDRAWAL;
                    reinvestBtn.classList.toggle('opacity-50', MOCK_AVAILABLE_BALANCE < MIN_WITHDRAWAL);
                }
                renderWithdrawalHistory(withdrawalHistoryCurrentPage);
            } else if (viewId === 'buyTPHistoryView') {
                renderBuyTPHistory(buyTPHistoryCurrentPage);
            } else if (viewId === 'dailyEarningHistoryView') {
                renderDailyEarningHistory(dailyEarningHistoryCurrentPage);
            } else if (viewId === 'aiTradingStatusView') {
                renderAITradingStatus(); 
            } else if (viewId === 'myTradePowerView') {
                renderMyTradePower();
            }
        }

        const timerElement = document.getElementById('settlement-timer');
        let totalSeconds = (19 * 3600) + (44 * 60) + 22;

        function formatTime(seconds) {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}h ${m}m ${s}s`;
        }

        function updateTimer() {
            totalSeconds--;
            if (totalSeconds < 0) {
                totalSeconds = (24 * 3600) - 1;
            }
            if (timerElement) {
                timerElement.textContent = `Settlement time: ${formatTime(totalSeconds)}`;
            }
        }

        function initializeTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready(); 
                
                const themeParams = window.Telegram.WebApp.themeParams;
                if (themeParams) {
                    document.documentElement.style.setProperty('--tg-bg-color', themeParams.bg_color || '#f0f2f5');
                    document.documentElement.style.setProperty('--tg-text-color', themeParams.text_color || '#1f2937');
                    document.documentElement.style.setProperty('--tg-hint-color', themeParams.hint_color || '#9ca3af');
                }

                if (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                    const userData = window.Telegram.WebApp.initDataUnsafe.user;
                    TG_USER_ID = String(userData.id);
                    let userName = userData.first_name || '';
                    if (userData.last_name) {
                        userName += ` ${userData.last_name}`;
                    }
                    if (userData.username) {
                        userName += ` (@${userData.username})`;
                    }
                    TG_USERNAME = userName.trim() || `User_${TG_USER_ID}`;
                }

                const userDisplay = document.getElementById('tgUserDisplay');
                const userLabel = document.getElementById('tgUserLabel');

                if (userDisplay && TG_USER_ID !== '000000000') {
                    userDisplay.textContent = TG_USER_ID;
                    userLabel.textContent = `Telegram ID (${TG_USERNAME}):`;
                }

                if (referralLinkInput) {
                    referralLinkInput.value = `https://t.me/${TELEGRAM_BOT_USERNAME}?start=${TG_USER_ID}`;
                }
            } else {
                console.warn('Telegram WebApp not found. Using fallback mock data.');
            }
        }


        // --- Initialization ---
        window.onload = function() {
            initializeTelegramWebApp(); 
            
            document.querySelectorAll('section[data-view]').forEach(view => {
                views[view.id] = view;
            });
            
            lucide.createIcons();
            checkWeekendEligibility();
            navigateTo(currentPage);
            setInterval(updateTimer, 1000);
        };
    </script>
</body>
</html>
